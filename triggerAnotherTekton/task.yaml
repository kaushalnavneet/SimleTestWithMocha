apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: trigger-another
spec:
  inputs:
    params:
      - name: another-pipeline-id
        description: the pipeline Id of another tekton pipeline to trigger
      - name: manual-trigger
        description: manual trigger name of another tekton pipeline
      - name: repository
        description: the git repository url that we interested in
      - name: toolchain-id
  stepTemplate:
    env:
      - name: API
        valueFrom:
          configMapKeyRef:
            name: cd-config
            key: API
      - name: REGION
        valueFrom:
          configMapKeyRef:
            name: cd-config
            key: REGION
      - name: TOOLCHAIN
        valueFrom:
          configMapKeyRef:
            name: toolchain
            key: toolchain.json
      - name: API_KEY
        valueFrom:
          secretKeyRef:
            name: cd-secret
            key: API_KEY
      - name: MYTOOLCHAIN
        valueFrom:
          configMapKeyRef:
            name: cd-config
            key: MYTOOLCHAIN
  steps:
    - name: play-with-toolchain-object
      image: ibmcom/pipeline-base-image
      env:
        - name: REPOSITORY
          value: $(inputs.params.repository)
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo $TOOLCHAIN
          echo " for TOOLCHAIN"
          PASSING_ENV="passing Env"
          echo $TOOLCHAIN | jq -r --arg git_repo "$REPOSITORY" '.services[] | select (.parameters.repo_url==$git_repo) | .parameters.token_url'
          echo "for MYTOOLCHAIN"
          echo $MYTOOLCHAIN | jq -r --arg git_repo "$REPOSITORY" '.services[] | select (.parameters.repo_url==$git_repo) | .parameters.token_url'
          GIT_TOKEN_URL=$(echo $MYTOOLCHAIN | jq -r --arg git_repo "$REPOSITORY" '.services[] | select (.parameters.repo_url==$git_repo) | .parameters.token_url')
          echo "GIT_TOKEN_URL is $GIT_TOKEN_URL"
    - name: toolchain-object-from-volume
      image: ibmcom/pipeline-base-image
      env:
        - name: REPOSITORY
          value: $(inputs.params.repository)
      command: ["/bin/sh", "-c"]
      args:
        - |
          cd /toolchain
          ls
          pwd
          cat toolchain.json | jq -r --arg git_repo "$REPOSITORY" '.services[] | select (.parameters.repo_url==$git_repo) | .parameters.token_url'
      volumeMounts:
        - mountPath: /toolchain
          name: toolchain-volume
    - name: get-toolchain-old-way
      image: ibmcom/pipeline-base-image
      env:
        - name: REPOSITORY
          value: $(inputs.params.repository)
        - name: TOOLCHAIN_ID
          value: $(inputs.params.toolchain-id)
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Testing env passing $PASSING_ENV"
          ibmcloud login -a $API -r $REGION --apikey $API_KEY ;
          TOKEN=$(ibmcloud iam oauth-tokens --output JSON | jq -r .iam_token)
          curl -s -X GET -o _toolchain.json -H "Accept: application/json" -H "Authorization: ${TOKEN}" "https://dev.console.test.cloud.ibm.com/devops/toolchains/$TOOLCHAIN_ID?env_id=ibm:ys1:us-south"
          cat _toolchain.json 
          if jq '.services' _toolchain.json > /dev/null 2>&1; then
            echo "Found toolchain with id $TOOLCHAIN_ID in region $REGION"
          else
            echo "Toolchain with id $TOOLCHAIN_ID in region $REGION not found"
            exit 1
          fi
          cat _toolchain.json | jq -r --arg git_repo "$REPOSITORY" '.services[] | select (.parameters.repo_url==$git_repo) | .parameters.token_url'
    - name: trigger-another-tekton-pipeline
      image: ibmcom/pipeline-base-image
      env:
        - name: ANOTHER_PIPELINE_ID
          value: $(inputs.params.another-pipeline-id)
        - name: MANUAL_TRIGGER_NAME
          value: $(inputs.params.manual-trigger)
        - name: REPOSITORY
          value: $(inputs.params.repository)
      command: ["/bin/sh", "-c"]
      args:
        - |
          ibmcloud login -a $API -r $REGION --apikey $API_KEY ;
          TOKEN=$(ibmcloud iam oauth-tokens --output JSON | jq -r .iam_token)
          curl -X POST \
            "https://devops-api.${REGION}.devops.cloud.ibm.com/v1/tekton_pipelines/${ANOTHER_PIPELINE_ID}/runs"\
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${TOKEN}" \
            -d "{\"eventListener\":\"${MANUAL_TRIGGER_NAME}\"}"
  volumes:
    - name: toolchain-volume
      configMap:
        # Provide the name of the ConfigMap containing the files you want
        # to add to the container
        name: toolchain